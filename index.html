<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–ê–Ω–æ–Ω—ñ–º–Ω—ñ –∑–Ω–∞–π–æ–º—Å—Ç–≤–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2, h3 {
      color: #0088cc;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
    }
    textarea, input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      margin: 8px 0 4px;
    }
    select[multiple] {
      height: 100px;
    }
    textarea {
      height: 100px;
      resize: vertical;
    }
    button {
      padding: 12px 24px;
      background: #0088cc;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:disabled {
      background: #ccc;
    }
    .status {
      margin-top: 10px;
      min-height: 24px;
      font-weight: bold;
    }
    .success { color: #2e8b57; }
    .error { color: #c0392b; }
    code {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 4px;
    }
    .form-section {
      display: none;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 12px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üîê –ê–Ω–æ–Ω—ñ–º–Ω—ñ –∑–Ω–∞–π–æ–º—Å—Ç–≤–∞</h2>
    <p>–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é:</p>

    <button onclick="showForm('post')" style="width:48%">üìù –ü–æ–¥–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</button>
    <button onclick="showForm('reply')" style="width:48%">üí¨ –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏</button>

    <!-- –§–æ—Ä–º–∞ –ø–æ–¥–∞—á—ñ -->
    <div id="postForm" class="form-section">
      <label>–Ü–º'—è <span style="color:red">*</span></label>
      <input type="text" id="userName" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –û–ª–µ–Ω–∞">

      <label>–í—ñ–∫ <span style="color:red">*</span></label>
      <input type="number" id="userAge" min="18" max="99" placeholder="–í—ñ–¥ 18 –¥–æ 99">

      <label>–û–≥–æ–ª–æ—à–µ–Ω–Ω—è <span style="color:red">*</span></label>
      <textarea id="postText" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –•–ª–æ–ø–µ—Ü—å, 25 —Ä–æ–∫—ñ–≤, –ª—é–±–ª—é –∫—ñ–Ω–æ —Ç–∞ –ø—Ä–æ–≥—É–ª—è–Ω–∫–∏ —É –õ—å–≤–æ–≤—ñ..."></textarea>

      <label>–•—Ç–æ —Ü—ñ–∫–∞–≤–∏—Ç—å <span style="color:red">*</span></label>
      <select id="interestedIn">
        <option value="">–û–±–µ—Ä—ñ—Ç—å...</option>
        <option value="male">–ß–æ–ª–æ–≤—ñ–∫</option>
        <option value="female">–ñ—ñ–Ω–∫–∞</option>
        <option value="couple">–ü–∞—Ä–∞</option>
        <option value="any">–ë–µ–∑ —Ä—ñ–∑–Ω–∏—Ü—ñ</option>
      </select>

      <label>–Ø–∫–∏–π –≤—ñ–∫ —Ü—ñ–∫–∞–≤–∏—Ç—å <span style="color:red">*</span></label>
      <select id="ageRange" multiple>
        <option value="18-22">18‚Äì22</option>
        <option value="23-30">23‚Äì30</option>
        <option value="31-40">31‚Äì40</option>
        <option value="41-50">41‚Äì50</option>
        <option value="50+">50+</option>
      </select>

      <label>–§–æ—Ç–æ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)</label>
      <input type="file" id="photoUpload" accept="image/*">

      <button onclick="submitPost()" id="submitBtn">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</button>
      <div id="postStatus" class="status"></div>
    </div>

    <!-- –§–æ—Ä–º–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ -->
    <div id="replyForm" class="form-section">
      <h3>üí¨ –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ –Ω–∞ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h3>
      <p>–í–≤–µ–¥—ñ—Ç—å ID –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: <code>5NOD</code>):</p>
      <input type="text" id="postId" placeholder="ID –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è">
      <textarea id="replyText" placeholder="–í–∞—à–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∞–≤—Ç–æ—Ä—É..."></textarea>
      <button onclick="submitReply()" id="submitReplyBtn">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –≤—ñ–¥–≥—É–∫</button>
      <div id="replyStatus" class="status"></div>
    </div>
  </div>

  <script>
    const WebApp = window.Telegram.WebApp;
    WebApp.ready();
    WebApp.expand();

    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzme9bv5wLH9fPp091ou9JSs81ybQbfcMV4psC0nod4HngiMN4LXIotTbokJqIF97hw/exec';

    function showForm(type) {
      document.getElementById('postForm').style.display = type === 'post' ? 'block' : 'none';
      document.getElementById('replyForm').style.display = type === 'reply' ? 'block' : 'none';
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è ID, —è–∫—â–æ Mini App –≤—ñ–¥–∫—Ä–∏—Ç–æ –∑ startapp=ID
    const urlParams = new URLSearchParams(window.location.search);
    const startAppId = urlParams.get('startapp');
    if (startAppId) {
      showForm('reply');
      document.getElementById('postId').value = startAppId.trim();
      document.getElementById('replyText').focus();
    }

    async function submitPost() {
      const name = document.getElementById('userName').value.trim();
      const age = document.getElementById('userAge').value.trim();
      const text = document.getElementById('postText').value.trim();
      const interestedIn = document.getElementById('interestedIn').value;
      const ageRange = Array.from(document.getElementById('ageRange').selectedOptions)
                            .map(opt => opt.value).join(', ');
      const photoInput = document.getElementById('photoUpload');
      const statusEl = document.getElementById('postStatus');
      const btn = document.getElementById('submitBtn');

      if (!name || !age || !text || !interestedIn || !ageRange) {
        statusEl.className = 'error';
        statusEl.innerText = '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ –ø–æ–ª—è.';
        return;
      }
      if (text.length < 10 || text.length > 500) {
        statusEl.className = 'error';
        statusEl.innerText = '–¢–µ–∫—Å—Ç: 10‚Äì500 —Å–∏–º–≤–æ–ª—ñ–≤.';
        return;
      }

      const userId = WebApp.initDataUnsafe?.user?.id;
      if (!userId) {
        statusEl.className = 'error';
        statusEl.innerText = '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∞—à ID.';
        return;
      }

      btn.disabled = true;
      statusEl.innerText = '–ù–∞–¥—Å–∏–ª–∞—î–º–æ...';

      const formData = new FormData();
      formData.append('action', 'post');
      formData.append('user_id', userId);
      formData.append('name', name);
      formData.append('age', age);
      formData.append('text', text);
      formData.append('interested_in', interestedIn);
      formData.append('age_range', ageRange);

      if (photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = () => {
          formData.append('photo_base64', reader.result.split(',')[1]);
          sendPost(formData, statusEl, btn);
        };
        reader.readAsDataURL(photoInput.files[0]);
      } else {
        sendPost(formData, statusEl, btn);
      }
    }

    async function sendPost(formData, statusEl, btn) {
      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          body: formData
        });
        const text = await response.text();
        if (text.includes('OK')) {
          statusEl.className = 'success';
          statusEl.innerText = '‚úÖ –û–≥–æ–ª–æ—à–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!';
        } else {
          throw new Error(text);
        }
      } catch (e) {
        statusEl.className = 'error';
        statusEl.innerText = '–ü–æ–º–∏–ª–∫–∞: ' + (e.message || '–Ω–µ–≤—ñ–¥–æ–º–∞');
      } finally {
        btn.disabled = false;
      }
    }

    async function submitReply() {
      const postId = document.getElementById('postId').value.trim();
      const text = document.getElementById('replyText').value.trim();
      const statusEl = document.getElementById('replyStatus');
      const btn = document.getElementById('submitReplyBtn');

      if (!postId || !text || text.length > 500) {
        statusEl.className = 'error';
        statusEl.innerText = '–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–∏–¥–≤–∞ –ø–æ–ª—è (–¥–æ 500 —Å–∏–º–≤–æ–ª—ñ–≤).';
        return;
      }

      const userId = WebApp.initDataUnsafe?.user?.id;
      if (!userId) {
        statusEl.className = 'error';
        statusEl.innerText = '–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∞—à ID.';
        return;
      }

      btn.disabled = true;
      statusEl.innerText = '–ù–∞–¥—Å–∏–ª–∞—î–º–æ...';

      try {
        const url = `${SCRIPT_URL}?action=reply&user_id=${encodeURIComponent(userId)}&post_id=${encodeURIComponent(postId)}&reply_text=${encodeURIComponent(text)}`;
        const response = await fetch(url);
        const text = await response.text();
        if (text.includes('OK')) {
          statusEl.className = 'success';
          statusEl.innerText = '‚úÖ –í—ñ–¥–≥—É–∫ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ!';
          document.getElementById('postId').value = '';
          document.getElementById('replyText').value = '';
        } else {
          throw new Error(text);
        }
      } catch (e) {
        statusEl.className = 'error';
        statusEl.innerText = '–ü–æ–º–∏–ª–∫–∞: ' + (e.message || '–Ω–µ–≤—ñ–¥–æ–º–∞');
      } finally {
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
